{% extends "layout.html" %}

{% block title %}{{ product.name }} - Omimas{% endblock %}

{% block content %}
<div class="product-detail-container">
    <div class="breadcrumb">
        <a href="{{ url_for('index') }}">Home</a> > 
        <a href="{{ url_for('category_page', category_name=product.category) }}">{{ product.category }}</a> > 
        <span>{{ product.name }}</span>
    </div>

    <div class="product-main">
        <div class="product-gallery">
            <div class="main-image">
                <img src="{{ product.image_url }}" alt="{{ product.name }}" id="mainProductImage" 
                     onerror="this.src='https://via.placeholder.com/500'">
            </div>
            {% if product_images and product_images|length > 1 %}
            <div class="thumbnail-gallery">
                {% for image in product_images %}
                <img src="{{ image }}" alt="Thumbnail {{ loop.index }}" class="thumbnail" 
                     onclick="changeMainImage('{{ image }}')"
                     onerror="this.src='https://via.placeholder.com/100'">
                {% endfor %}
            </div>
            {% endif %}
        </div>

        <div class="product-info">
            <h1>{{ product.name }}</h1>
            
            <div class="product-meta">
                <span class="product-sku">SKU: OM{{ product.id }}</span>
                <span class="product-stock in-stock">In Stock</span>
            </div>

            <div class="product-price-section">
                <span class="price-main">{{ product.price }} {{ product.currency }}</span>
                <span class="price-tax">incl. VAT</span>
            </div>

            <div class="product-rating-overview">
                <div class="rating-stars">
                    {% set avg_rating = product_rating[0] %}
                    {% set full_stars = avg_rating|int %}
                    {% set half_star = (avg_rating - full_stars) >= 0.5 %}
                    
                    {% for i in range(full_stars) %}
                    <span class="star full">★</span>
                    {% endfor %}
                    
                    {% if half_star %}
                    <span class="star half">★</span>
                    {% endif %}
                    
                    {% for i in range(5 - full_stars - half_star|int) %}
                    <span class="star empty">★</span>
                    {% endfor %}
                    
                    <span class="rating-value">{{ "%.1f"|format(avg_rating) }}</span>
                </div>
                <span class="review-count">({{ product_rating[1] }} reviews)</span>
                <a href="{{ url_for('product_reviews', product_id=product.id) }}" class="view-all-reviews">
                    View all reviews
                </a>
            </div>

            <div class="product-description">
                <h3>Description</h3>
                <p>{{ product.description }}</p>
            </div>

            <div class="product-actions">
                <div class="quantity-selector">
                    <label for="quantity">Quantity:</label>
                    <div class="quantity-controls">
                        <button type="button" onclick="decreaseQuantity()">-</button>
                        <input type="number" id="quantity" name="quantity" value="1" min="1" max="10">
                        <button type="button" onclick="increaseQuantity()">+</button>
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="add-to-cart-btn large" onclick="addToCartFromProductPage({{ product.id }})">
                        <i class="fas fa-shopping-cart"></i> Add to Cart
                    </button>
                    <button class="buy-now-btn" onclick="buyNow({{ product.id }})">
                        <i class="fas fa-bolt"></i> Buy Now
                    </button>
                </div>
            </div>

            <div class="product-features">
                <div class="feature-item">
                    <i class="fas fa-truck"></i>
                    <span>Free shipping on orders over 200 PLN</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-undo"></i>
                    <span>30-day return policy</span>
                </div>
                <div class="feature-item">
                    <i class="fas fa-shield-alt"></i>
                    <span>2-year warranty</span>
                </div>
            </div>

            <div class="product-details">
                <h3>Product Details</h3>
                <div class="details-grid">
                    <div class="detail-item">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">{{ product.category }}</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Brand:</span>
                        <span class="detail-value">Omimas Premium</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Warranty:</span>
                        <span class="detail-value">2 years</span>
                    </div>
                    <div class="detail-item">
                        <span class="detail-label">Product ID:</span>
                        <span class="detail-value">OM{{ product.id }}</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ürün Yorumları Bölümü -->
    <section class="product-reviews">
        <h2>Customer Reviews</h2>
        
        <div class="review-stats">
            <div class="average-rating">
                <span class="rating-number">{{ "%.1f"|format(product_rating[0]) }}</span>
                <span class="stars">★★★★★</span>
                <span class="review-count">({{ product_rating[1] }} reviews)</span>
            </div>
            
            <div class="rating-distribution">
                {% for i in range(5, 0, -1) %}
                <div class="rating-bar">
                    <span class="star-count">{{ i }}★</span>
                    <div class="bar-container">
                        <div class="bar" style="width: {% if product_rating[1] > 0 %}{{ (reviews|selectattr('rating', 'equalto', i)|list|length / product_rating[1] * 100)|round }}%{% else %}0%{% endif %}"></div>
                    </div>
                    <span class="percentage">{% if product_rating[1] > 0 %}{{ (reviews|selectattr('rating', 'equalto', i)|list|length / product_rating[1] * 100)|round }}%{% else %}0%{% endif %}</span>
                </div>
                {% endfor %}
            </div>
        </div>

        {% if session.username %}
        <div class="add-review-form">
            <h3>Add Your Review</h3>
            <form method="POST" action="{{ url_for('add_review', product_id=product.id) }}">
                <div class="rating-input">
                    <label>Your Rating:</label>
                    <div class="star-rating">
                        {% for i in range(5, 0, -1) %}
                        <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" required>
                        <label for="star{{ i }}">★</label>
                        {% endfor %}
                    </div>
                </div>
                
                <div class="comment-input">
                    <label for="comment">Your Review:</label>
                    <textarea id="comment" name="comment" rows="4" required minlength="10" 
                              placeholder="Share your experience with this product..."></textarea>
                </div>
                
                <button type="submit" class="submit-review-btn">
                    <i class="fas fa-paper-plane"></i> Submit Review
                </button>
            </form>
        </div>
        {% else %}
        <div class="login-to-review">
            <div class="login-prompt">
                <i class="fas fa-comment-alt fa-3x"></i>
                <h3>Want to share your experience?</h3>
                <p>Please <a href="{{ url_for('login') }}">login</a> to leave a review and help other customers.</p>
                <a href="{{ url_for('login') }}" class="btn-secondary">
                    <i class="fas fa-sign-in-alt"></i> Login to Review
                </a>
            </div>
        </div>
        {% endif %}

        <div class="reviews-list">
            {% if product.reviews and product.reviews|length > 0 %}
                {% for review in product.reviews %}
                {% if review.is_approved %}
                <div class="review-item">
                    <div class="review-header">
                        <div class="reviewer-info">
                            <span class="reviewer-name">{{ review.user.username }}</span>
                            <span class="review-date">{{ review.created_at.strftime('%B %d, %Y') }}</span>
                        </div>
                        <div class="review-rating">
                            {% for i in range(5) %}
                            <span class="star {% if i < review.rating %}full{% else %}empty{% endif %}">★</span>
                            {% endfor %}
                        </div>
                    </div>
                    <p class="review-comment">{{ review.comment }}</p>
                    
                    <div class="review-helpful">
                        <span>Was this review helpful?</span>
                        <button class="helpful-btn">Yes</button>
                        <button class="helpful-btn">No</button>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
            {% else %}
                <div class="no-reviews">
                    <i class="fas fa-comments fa-3x"></i>
                    <h3>No reviews yet</h3>
                    <p>Be the first to review this product and share your experience!</p>
                </div>
            {% endif %}
        </div>
    </section>

    {% if similar_products %}
    <section class="similar-products">
        <h2>Similar Products</h2>
        <div class="products-grid">
            {% for similar in similar_products %}
            <div class="product-card">
                <a href="{{ url_for('product_detail', product_id=similar.id) }}" class="product-link">
                    <div class="product-image">
                        <img src="{{ similar.image_url }}" alt="{{ similar.name }}" 
                             onerror="this.src='https://via.placeholder.com/300'">
                    </div>
                    <div class="product-info">
                        <h3 class="product-title">{{ similar.name }}</h3>
                        <p class="product-category">{{ similar.category }}</p>
                        <p class="product-price">{{ similar.price }} {{ similar.currency }}</p>
                        <div class="product-rating">
                            <span class="stars">★★★★☆</span>
                            <span class="rating-count">(42)</span>
                        </div>
                    </div>
                </a>
                <button class="add-to-cart-btn" onclick="addToCart({{ similar.id }}, 1)">
                    <i class="fas fa-shopping-cart"></i> Add to Cart
                </button>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endif %}
</div>

<script>
function changeMainImage(imageUrl) {
    document.getElementById('mainProductImage').src = imageUrl;
}

function increaseQuantity() {
    const input = document.getElementById('quantity');
    if (input.value < 10) input.value++;
}

function decreaseQuantity() {
    const input = document.getElementById('quantity');
    if (input.value > 1) input.value--;
}

function addToCartFromProductPage(productId) {
    const quantity = document.getElementById('quantity').value;
    addToCart(productId, parseInt(quantity));
}

function addToCart(productId, quantity = 1) {
    const formData = new FormData();
    formData.append('quantity', quantity);
    
    fetch('/add_to_cart/' + productId, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            alert('Product added to cart: ' + data.message);
            updateCartCount();
        } else {
            alert('Error: ' + data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while adding to cart');
    });
}

function buyNow(productId) {
    const quantity = document.getElementById('quantity').value;
    addToCart(productId, parseInt(quantity));
    
    // Sepete ekledikten sonra checkout sayfasına yönlendir
    setTimeout(() => {
        window.location.href = '/checkout';
    }, 1000);
}

// Star rating interaction
document.addEventListener('DOMContentLoaded', function() {
    const starInputs = document.querySelectorAll('.star-rating input');
    const starLabels = document.querySelectorAll('.star-rating label');
    
    starLabels.forEach((label, index) => {
        label.addEventListener('mouseenter', function() {
            for (let i = 0; i <= index; i++) {
                starLabels[i].style.color = '#f39c12';
            }
        });
        
        label.addEventListener('mouseleave', function() {
            const checkedInput = document.querySelector('.star-rating input:checked');
            if (checkedInput) {
                const checkedIndex = Array.from(starInputs).indexOf(checkedInput);
                starLabels.forEach((label, i) => {
                    label.style.color = i <= checkedIndex ? '#f39c12' : '#ddd';
                });
            } else {
                starLabels.forEach(label => label.style.color = '#ddd');
            }
        });
    });
    
    starInputs.forEach((input, index) => {
        input.addEventListener('change', function() {
            starLabels.forEach((label, i) => {
                label.style.color = i <= index ? '#f39c12' : '#ddd';
            });
        });
    });
});
</script>

<style>
.product-rating-overview {
    margin: 1.5rem 0;
    padding: 1rem;
    background: #f8f9fa;
    border-radius: 8px;
}

.rating-stars {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.star {
    font-size: 1.2rem;
}

.star.full {
    color: #f39c12;
}

.star.half {
    color: #f39c12;
    opacity: 0.7;
}

.star.empty {
    color: #ddd;
}

.rating-value {
    font-weight: bold;
    color: #2c3e50;
}

.view-all-reviews {
    color: #ff6b35;
    text-decoration: none;
    font-size: 0.9rem;
}

.view-all-reviews:hover {
    text-decoration: underline;
}

.product-features {
    margin: 1.5rem 0;
    padding: 1rem 0;
    border-top: 1px solid #eee;
    border-bottom: 1px solid #eee;
}

.feature-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
    color: #27ae60;
}

.feature-item i {
    width: 20px;
}

/* Yorum stilleri */
.rating-distribution {
    margin: 1rem 0;
}

.rating-bar {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

.star-count {
    width: 30px;
    font-weight: 500;
}

.bar-container {
    flex: 1;
    height: 8px;
    background: #eee;
    border-radius: 4px;
    overflow: hidden;
}

.bar {
    height: 100%;
    background: #f39c12;
    border-radius: 4px;
    transition: width 0.3s ease;
}

.percentage {
    width: 40px;
    text-align: right;
    font-size: 0.9rem;
    color: #7f8c8d;
}

.login-prompt {
    text-align: center;
    padding: 2rem;
    background: #f8f9fa;
    border-radius: 8px;
    border: 2px dashed #ddd;
}

.review-item {
    border: 1px solid #eee;
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1rem;
    background: white;
}

.review-header {
    display: flex;
    justify-content: space-between;
    align-items: start;
    margin-bottom: 1rem;
}

.reviewer-info {
    display: flex;
    flex-direction: column;
}

.reviewer-name {
    font-weight: 600;
    color: #2c3e50;
}

.review-date {
    font-size: 0.9rem;
    color: #7f8c8d;
}

.review-helpful {
    margin-top: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #f1f1f1;
}

.helpful-btn {
    padding: 0.3rem 0.8rem;
    margin-left: 0.5rem;
    border: 1px solid #ddd;
    background: white;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9rem;
}

.helpful-btn:hover {
    background: #f8f9fa;
}

.no-reviews {
    text-align: center;
    padding: 3rem;
    color: #7f8c8d;
}

/* Responsive */
@media (max-width: 768px) {
    .product-main {
        grid-template-columns: 1fr;
    }
    
    .review-header {
        flex-direction: column;
        gap: 0.5rem;
    }
    
    .rating-bar {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.3rem;
    }
    
    .bar-container {
        width: 100%;
    }
}
</style>
{% endblock %}